{
  "id": "0a6815d0-3981-4605-ba2a-ee9d9996e815",
  "name": "ContrastGate",
  "friendlyName": "Verify application vulnerabilities",
  "description": "Verifies if the amount of vulnerabilities per severity for the selected app is below the configured limits.",
  "helpUrl": "",
  "helpMarkDown": "",
  "category": "Deploy",
  "visibility": [
    "Release"
  ],
  "runsOn": [
    "ServerGate"
  ],
  "author": "contrast-security",
  "version": {
    "Major": 1,
    "Minor": 0,
    "Patch": 0
  },
  "preview": false,
  "inputs": [
    {
      "name": "ContrastService",
      "type": "connectedService:Contrast",
      "label": "Contrast Service Connection",
      "defaultValue": "",
      "required": true,
      "helpMarkDown": "Select the Contrast connection to use."
    },
    {
      "name": "Application",
      "type": "pickList",
      "label": "Application",
      "required": true,
      "helpMarkDown": "The application that will be used to evaluate the vulnerabilities conditions."
    },
    {
      "name": "StatusFilter",
      "type": "pickList",
      "label": "Allowed Status",
      "required": false,
      "visibleRule": "Application != \"\"",
      "helpMarkDown": "The allowed status by which the evaluation will be done when comparing counters.",
      "properties": {
        "MultiSelectFlatList": "True",
        "EditableOptions": "False"
      }
    },
    {
      "name": "AppVersionFilter",
      "type": "pickList",
      "label": "Build Number",
      "required": false,
      "visibleRule": "Application != \"\"",
      "helpMarkDown": "The build number to filter the vulnerabilities results."
    },
    {
      "name": "CriticalLimit",
      "type": "string",
      "label": "Critical",
      "required": true,
      "visibleRule": "Application != \"\"",
      "helpMarkDown": "Set the maximum amount of vulnerabilities for the critical severity."
    },
    {
      "name": "HighLimit",
      "type": "string",
      "label": "High",
      "required": true,
      "visibleRule": "Application != \"\"",
      "helpMarkDown": "Set the maximum amount of vulnerabilities for the high severity."
    },
    {
      "name": "MediumLimit",
      "type": "string",
      "label": "Medium",
      "required": true,
      "visibleRule": "Application != \"\"",
      "helpMarkDown": "Set the maximum amount of vulnerabilities for the medium severity."
    },
    {
      "name": "LowLimit",
      "type": "string",
      "label": "Low",
      "required": true,
      "visibleRule": "Application != \"\"",
      "helpMarkDown": "Set the maximum amount of vulnerabilities for the low severity."
    },
    {
      "name": "NoteLimit",
      "type": "string",
      "label": "Note",
      "required": true,
      "visibleRule": "Application != \"\"",
      "helpMarkDown": "Set the maximum amount of vulnerabilities for the note severity."
    }
  ],
  "dataSourceBindings": [
    {
      "target": "Application",
      "endpointId": "$(ContrastService)",
      "EndpointUrl": "{{endpoint.url}}Contrast/api/ng/{{endpoint.orgId}}/applications?expand=skip_links&filterServers=&filterTechs=&includeArchived=false&includeMerged=true",
      "resultSelector": "jsonpath:$.applications[*]",
      "resultTemplate": "{ \"Value\" : \"{{{app_id}}}\", \"DisplayValue\" : \"{{{name}}}\" }"
    },
    {
      "target": "StatusFilter",
      "endpointId": "$(ContrastService)",
      "EndpointUrl": "{{endpoint.url}}Contrast/api/ng/{{endpoint.orgId}}/traces/$(Application)/filter/status/listing",
      "resultSelector": "jsonpath:$.filters[*]",
      "resultTemplate": "{ \"Value\" : \"{{{keycode}}}\", \"DisplayValue\" : \"{{{label}}}\" }"
    },
    {
      "target": "AppVersionFilter",
      "endpointId": "$(ContrastService)",
      "EndpointUrl": "{{endpoint.url}}Contrast/api/ng/{{endpoint.orgId}}/traces/$(Application)/filter/appversiontags/listing",
      "resultSelector": "jsonpath:$.filters[*]",
      "resultTemplate": "{ \"Value\" : \"{{{keycode}}}\", \"DisplayValue\" : \"{{{label}}}\" }"
    }
  ],
  "execution": {
    "HttpRequest": {
      "Execute": {
        "EndpointId": "$(ContrastService)",
        "EndpointUrl": "$(endpoint.url)Contrast/api/ng/$(endpoint.orgId)/applications/$(Application)/breakdown/trace?status=$(StatusFilter)&appversion=$(AppVersionFilter)",
        "Method": "GET",
        "Expression": "and(le(jsonpath('$.trace_breakdown.criticals')[0], $(CriticalLimit)), le(jsonpath('$.trace_breakdown.highs')[0], $(HighLimit)), le(jsonpath('$.trace_breakdown.meds')[0], $(MediumLimit)), le(jsonpath('$.trace_breakdown.lows')[0], $(LowLimit)), le(jsonpath('$.trace_breakdown.notes')[0], $(NoteLimit)))"
      }
    }
  }
}