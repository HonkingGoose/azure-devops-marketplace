{
    "$schema": "https://raw.githubusercontent.com/Microsoft/azure-pipelines-task-lib/master/tasks.schema.json",
    "id": "ea42b06e-b052-4e88-bdc7-751acf970077",
    "name": "infracag2certrequest",
    "friendlyName": "InfraCA G2 certificate request task",
    "description": "Request certificate from InfraCA G2 via Azure Cloud RA",
    "helpMarkDown": "This task can be used to request a certificate from the InfraCA G2. Instructions for the task can be found [here](https://confluence.aws.abnamro.org/display/CS/Azure+DevOps+Pipeline+Extension)",
    "category": "Utility",
    "author": "O&I Certificate Services",
    "version": {
        "Major": 0,
        "Minor": 3,
        "Patch": 9
    },
    "instanceNameFormat": "Request certificate from InfraCA G2 via Azure Cloud RA",
    "inputs": [
		{
            "name": "ConnectedServiceNameARM",
            "aliases": [
                "azureSubscription"
            ],
            "type": "connectedService:AzureRM",
            "label": "Azure Subscription",
            "defaultValue": "",
            "required": true,
            "helpMarkDown": "Azure Resource Manager subscription to configure before running PowerShell",
            "properties": {
                "EndpointFilterRule": "ScopeLevel != AzureMLWorkspace"
            }
        },
		{
			"name": "action",
			"type": "pickList",
			"label": "Action",
			"defaultValue": "New Request",
			"required": true,
			"helpMarkDown": "Select action to perform",
			"options": {
				"new": "New Request",
				"renew": "Renewal"
			}
		},
		{
			"name": "resourcegroup",
			"type": "pickList",
			"label": "Resource Group",
			"required": true,
			"helpMarkDown": "Provide the name of the Resource Group.",
			"properties": {
				"EditableOptions": "True"
			}
        },
		{
			"name": "keyvault",
			"type": "pickList",
			"label": "Key vault",
			"required": true,
			"helpMarkDown": "Provide the name of an existing key vault in which the certificate will be stored.",
			"properties": {
				"EditableOptions": "True"
			}
		},
        {
            "name": "commonname",
            "type": "string",
            "label": "Common Name",
            "defaultValue": "",
            "required": true,
            "helpMarkDown": "Certificate common name (also known as subject). The common name must adhere to the naming conventions [see here](https://confluence.aws.abnamro.org/display/CS/Azure+DevOps+Pipeline+Extension)"
        },        
		{
            "name": "email",
            "type": "string",
            "label": "E-mail address",
            "defaultValue": "",
            "required": true,
            "helpMarkDown": "E-mail address that is used to send expiry notifications."
        },        
		{
            "name": "certname",
            "type": "string",
            "label": "Certificate Name",
            "defaultValue": "",
            "required": true,
            "helpMarkDown": "Name that will be used for the certificate in the Azure Key Vault. This must be an existing certificate for renewals or revocations."
        },
		{
            "name": "oarid",
            "type": "string",
            "label": "OAR-id",
            "defaultValue": "",
            "required": true,
            "helpMarkDown": "OAR-id for which the certificate will be used. The OAR-id will be in the 2nd SAN field of the certificate."
        },
		{
			"name": "environment",
			"type": "pickList",
			"label": "Environment",
			"defaultValue": "D",
			"required": true,
			"helpMarkDown": "Select one, must match the resource group",
			"options": {
				"D": "D",
				"T": "T",
				"A": "A",
				"P": "P"
			}
		},
		{
			"name": "san",
			"type": "multiLine",
			"label": "Subject Alternative Names",
			"defaultValue": "",
			"required": false,
			"helpMarkDown": "Subject Alternative Names, one per line"
		}
    ],
	"dataSourceBindings": [
		{
            "target": "resourcegroup",
            "endpointId": "$(ConnectedServiceNameARM)",
            "dataSourceName": "AzureResourceGroups"
        },
		{
           "target": "keyvault",
           "endpointId": "$(ConnectedServiceNameARM)",
           "dataSourceName": "AzureKeyVaultsListV2",
           "resultTemplate": "{ \"Value\" : \"{{{name}}}\", \"DisplayValue\" : \"{{{name}}}\" }"
		}
                
                
                
	],
    "execution": {
        "PowerShell3": {
            "target": "azurepowershell.ps1",
            "platforms": [
                "windows"
            ]
        }
    }
}